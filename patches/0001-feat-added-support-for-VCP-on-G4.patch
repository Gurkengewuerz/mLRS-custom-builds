From 8c1f542beec1b4a9a362bae8d2d444aaed0c6a92 Mon Sep 17 00:00:00 2001
From: Gurkengewuerz <niklas@schuetrumpf.net>
Date: Sat, 16 Sep 2023 21:02:48 +0200
Subject: [PATCH] feat: added support for VCP on G4

---
 mLRS/modules/stm32-usb-device/usbd_conf.c | 5 +++++
 mLRS/modules/stm32-usb-device/usbd_conf.h | 8 ++++++++
 tools/run_copy_st_drivers.py              | 2 ++
 tools/run_make_firmwares3.py              | 2 ++
 4 files changed, 17 insertions(+)

diff --git a/mLRS/modules/stm32-usb-device/usbd_conf.c b/mLRS/modules/stm32-usb-device/usbd_conf.c
index 699fcfc..44371ce 100644
--- a/mLRS/modules/stm32-usb-device/usbd_conf.c
+++ b/mLRS/modules/stm32-usb-device/usbd_conf.c
@@ -23,6 +23,11 @@
 #include "usbd_cdc.h"
 #include "usbd_conf.h"
 
+#ifndef USB_IRQn
+  #ifdef USB_LP_IRQn
+    #define USB_IRQn USB_LP_IRQn
+  #endif
+#endif
 
 PCD_HandleTypeDef hpcd_USB_FS;
 void Error_Handler(void);
diff --git a/mLRS/modules/stm32-usb-device/usbd_conf.h b/mLRS/modules/stm32-usb-device/usbd_conf.h
index 1836a53..ecbad32 100644
--- a/mLRS/modules/stm32-usb-device/usbd_conf.h
+++ b/mLRS/modules/stm32-usb-device/usbd_conf.h
@@ -26,8 +26,16 @@ extern "C" {
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
+
+#ifdef STM32F072xB
 #include "stm32f0xx.h"
 #include "stm32f0xx_hal.h"
+#endif
+ 
+#ifdef STM32G431xx
+#include "stm32g4xx.h"
+#include "stm32g4xx_hal.h"
+#endif
 
 
 #define USBD_MAX_NUM_INTERFACES                     1U
diff --git a/tools/run_copy_st_drivers.py b/tools/run_copy_st_drivers.py
index b39968f..b7b1517 100755
--- a/tools/run_copy_st_drivers.py
+++ b/tools/run_copy_st_drivers.py
@@ -112,6 +112,8 @@ g4xx_hal_files_to_include = [
   'stm32g4xx_hal_dma.c',
   'stm32g4xx_hal_i2c.c',
   'stm32g4xx_hal_i2c_ex.c',
+  'stm32g4xx_hal_pcd.c',
+  'stm32g4xx_hal_pcd_ex.c',
 ]
 
 wlxx_hal_files_to_include = [
diff --git a/tools/run_make_firmwares3.py b/tools/run_make_firmwares3.py
index d4f2160..dfee081 100755
--- a/tools/run_make_firmwares3.py
+++ b/tools/run_make_firmwares3.py
@@ -215,6 +215,8 @@ MLRS_SOURCES_HAL_STM32G4 = [
     os.path.join('Drivers','STM32G4xx_HAL_Driver','Src','stm32g4xx_hal.c'),
     os.path.join('Drivers','STM32G4xx_HAL_Driver','Src','stm32g4xx_hal_cortex.c'),
     os.path.join('Drivers','STM32G4xx_HAL_Driver','Src','stm32g4xx_hal_dma.c'),
+    os.path.join('Drivers','STM32G4xx_HAL_Driver','Src','stm32g4xx_hal_pcd.c'),
+    os.path.join('Drivers','STM32G4xx_HAL_Driver','Src','stm32g4xx_hal_pcd_ex.c'),
     os.path.join('Drivers','STM32G4xx_HAL_Driver','Src','stm32g4xx_hal_flash.c'),
     os.path.join('Drivers','STM32G4xx_HAL_Driver','Src','stm32g4xx_hal_flash_ex.c'),
     os.path.join('Drivers','STM32G4xx_HAL_Driver','Src','stm32g4xx_hal_i2c.c'),
-- 
2.39.2.windows.1

