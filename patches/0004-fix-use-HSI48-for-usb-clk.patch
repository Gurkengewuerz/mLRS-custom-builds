From 6b8cf2b5106412b1c868622ee91d8c76c57dfc06 Mon Sep 17 00:00:00 2001
From: Gurkengewuerz <niklas@schuetrumpf.net>
Date: Sun, 17 Sep 2023 13:40:29 +0200
Subject: [PATCH] fix: use HSI48 for usb clk

---
 mLRS/modules/stm32-usb-device/usbd_cdc_if.c | 2 +-
 mLRS/modules/stm32-usb-device/usbd_conf.h   | 2 ++
 2 files changed, 3 insertions(+), 1 deletion(-)

diff --git a/mLRS/modules/stm32-usb-device/usbd_cdc_if.c b/mLRS/modules/stm32-usb-device/usbd_cdc_if.c
index abe9762..127c12f 100644
--- a/mLRS/modules/stm32-usb-device/usbd_cdc_if.c
+++ b/mLRS/modules/stm32-usb-device/usbd_cdc_if.c
@@ -58,7 +58,7 @@ void usb_init(void)
     // copied from SystemClock_Config()
     RCC_PeriphCLKInitTypeDef PeriphClkInit = {};
     PeriphClkInit.PeriphClockSelection = RCC_PERIPHCLK_USB;
-    PeriphClkInit.UsbClockSelection = RCC_USBCLKSOURCE_PLL;
+    PeriphClkInit.UsbClockSelection = USBD_CLK_SELECT;
 
     if (HAL_RCCEx_PeriphCLKConfig(&PeriphClkInit) != HAL_OK) {
         //Error_Handler();
diff --git a/mLRS/modules/stm32-usb-device/usbd_conf.h b/mLRS/modules/stm32-usb-device/usbd_conf.h
index 5e0e2e5..38d7aa8 100644
--- a/mLRS/modules/stm32-usb-device/usbd_conf.h
+++ b/mLRS/modules/stm32-usb-device/usbd_conf.h
@@ -32,6 +32,7 @@ extern "C" {
   #include "stm32f0xx_hal.h"
   #define USBD_IRQn         USB_IRQn
   #define USBD_IRQHandler   USB_IRQHandler
+  #define USBD_CLK_SELECT   RCC_USBCLKSOURCE_PLL
 
 #elif defined STM32G431xx
   #include "stm32g4xx.h"
@@ -39,6 +40,7 @@ extern "C" {
 
   #define USBD_IRQn         USB_LP_IRQn
   #define USBD_IRQHandler   USB_LP_IRQHandler
+  #define USBD_CLK_SELECT   RCC_USBCLKSOURCE_HSI48
 
 #endif
 
-- 
2.42.0.windows.2

